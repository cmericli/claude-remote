<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Remote</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --accent-green: #4caf50;
            --accent-blue: #2196f3;
            --accent-orange: #ff9800;
            --accent-purple: #9c27b0;
            --text-primary: #eee;
            --text-secondary: #aaa;
        }
        * { box-sizing: border-box; margin: 0; padding: 0; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary); color: var(--text-primary);
            height: 100vh; display: flex; flex-direction: column;
        }
        header {
            background: var(--bg-secondary); padding: 12px 20px;
            display: flex; align-items: center; justify-content: space-between;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        .logo { font-size: 1.2em; font-weight: 600; color: var(--accent); }
        .session-info { font-size: 0.9em; color: var(--text-secondary); display: flex; align-items: center; gap: 8px; }
        .mode-badge { font-size: 0.75em; padding: 2px 8px; border-radius: 3px; text-transform: uppercase; font-weight: 600; }
        .mode-badge.spectator { background: var(--accent-blue); }
        .mode-badge.interactive { background: var(--accent-green); }
        .mode-badge.browsing { background: var(--accent-orange); }
        main { flex: 1; display: flex; overflow: hidden; }
        .panel { width: 350px; background: var(--bg-secondary); border-right: 1px solid var(--bg-tertiary); display: flex; flex-direction: column; }
        .tabs { display: flex; border-bottom: 1px solid var(--bg-tertiary); }
        .tab { flex: 1; padding: 10px; text-align: center; cursor: pointer; background: none; border: none; color: var(--text-secondary); font-size: 0.9em; }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        .session-list { flex: 1; overflow-y: auto; padding: 10px; }
        .session-item { padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary); border-radius: 6px; border-left: 3px solid transparent; }
        .session-item.tmux { border-left-color: var(--accent-green); }
        .session-item.terminal { border-left-color: var(--accent-purple); }
        .session-name { font-weight: 500; display: flex; align-items: center; gap: 6px; flex-wrap: wrap; }
        .badge { font-size: 0.65em; padding: 2px 5px; border-radius: 3px; color: white; }
        .badge.tmux { background: var(--accent-green); }
        .badge.terminal { background: var(--accent-purple); }
        .session-meta { font-size: 0.8em; color: var(--text-secondary); margin-top: 2px; }
        .session-path { font-family: monospace; font-size: 0.75em; color: var(--text-secondary); margin-top: 4px; word-break: break-all; }
        .session-actions { display: flex; gap: 6px; margin-top: 10px; flex-wrap: wrap; }
        .session-btn { padding: 6px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8em; font-weight: 500; transition: opacity 0.2s; }
        .session-btn:hover { opacity: 0.85; }
        .session-btn.browse { background: var(--accent-orange); color: white; }
        .session-btn.view { background: var(--accent-blue); color: white; }
        .session-btn.attach { background: var(--accent-green); color: white; }
        .session-btn.resume { background: var(--accent); color: white; }
        .session-btn:disabled { opacity: 0.4; cursor: not-allowed; }
        .no-sessions { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        .new-session { padding: 15px; border-top: 1px solid var(--bg-tertiary); }
        .new-session input { width: 100%; padding: 10px; margin-bottom: 8px; background: var(--bg-primary); border: 1px solid var(--bg-tertiary); border-radius: 4px; color: var(--text-primary); font-size: 0.9em; }
        .new-session input:focus { outline: none; border-color: var(--accent); }
        .btn { width: 100%; padding: 10px; background: var(--accent); color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9em; font-weight: 500; }
        .btn:hover { opacity: 0.9; }
        .content-area { flex: 1; display: flex; flex-direction: column; background: #000; position: relative; overflow: hidden; }
        .terminal-placeholder { flex: 1; display: flex; align-items: center; justify-content: center; color: var(--text-secondary); flex-direction: column; gap: 10px; }
        #terminal { flex: 1; padding: 10px; display: none; }
        .spectator-banner { position: absolute; top: 0; left: 0; right: 0; background: var(--accent-blue); color: white; padding: 6px 15px; font-size: 0.85em; text-align: center; display: none; z-index: 10; }
        .spectator-banner.visible { display: block; }
        #conversationView { flex: 1; overflow-y: auto; padding: 20px; background: var(--bg-primary); display: none; }
        #conversationView.visible { display: block; }
        .conv-header { padding: 15px; background: var(--bg-secondary); border-radius: 8px; margin-bottom: 20px; }
        .conv-header h2 { font-size: 1.1em; margin-bottom: 5px; }
        .conv-header .meta { font-size: 0.85em; color: var(--text-secondary); }
        .message { margin-bottom: 15px; padding: 12px 15px; border-radius: 8px; max-width: 90%; }
        .message.user { background: var(--accent); margin-left: auto; }
        .message.assistant { background: var(--bg-secondary); }
        .message .role { font-size: 0.75em; text-transform: uppercase; opacity: 0.7; margin-bottom: 5px; }
        .message .content { white-space: pre-wrap; word-break: break-word; font-size: 0.9em; line-height: 1.5; }
        .status { padding: 8px 15px; font-size: 0.85em; background: var(--bg-secondary); border-top: 1px solid var(--bg-tertiary); display: flex; align-items: center; gap: 8px; }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
        .status-dot.connected { background: #4caf50; }
        .status-dot.spectator { background: #2196f3; }
        .status-dot.browsing { background: #ff9800; }
        .status-dot.connecting { background: #ff9800; animation: pulse 1s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        @media (max-width: 768px) {
            .panel { position: fixed; left: 0; top: 0; bottom: 0; z-index: 100; transform: translateX(-100%); transition: transform 0.3s; width: 85%; max-width: 350px; }
            .panel.open { transform: translateX(0); }
            .overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 99; }
            .overlay.open { display: block; }
        }
        @media (min-width: 769px) { .menu-toggle, .overlay { display: none; } }
        .menu-toggle { background: none; border: none; color: var(--text-primary); font-size: 1.5em; cursor: pointer; padding: 5px; }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="menu-toggle" onclick="togglePanel()">‚ò∞</button>
            <span class="logo">Claude Remote</span>
        </div>
        <div class="session-info">
            <span id="currentSession">No session</span>
            <span class="mode-badge" id="modeBadge" style="display:none;"></span>
        </div>
    </header>
    <main>
        <div class="overlay" onclick="togglePanel()"></div>
        <aside class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('active')">Active</button>
                <button class="tab" onclick="switchTab('history')">History</button>
            </div>
            <div class="session-list" id="activeSessionList"><div class="no-sessions">Loading...</div></div>
            <div class="session-list" id="historySessionList" style="display:none;"><div class="no-sessions">Loading...</div></div>
            <div class="new-session">
                <input type="text" id="sessionName" placeholder="Session name" value="Claude Session">
                <input type="text" id="workingDir" placeholder="Working directory" value="~">
                <input type="text" id="resumeId" placeholder="Resume session ID (optional)">
                <button class="btn" onclick="createSession()">New Session</button>
            </div>
        </aside>
        <div class="content-area">
            <div class="spectator-banner" id="spectatorBanner">üëÅ Spectator Mode - Read Only</div>
            <div class="terminal-placeholder" id="placeholder">
                <div>Select a session</div>
                <small>tmux = can attach, terminal = browse only</small>
            </div>
            <div id="terminal"></div>
            <div id="conversationView"></div>
        </div>
    </main>
    <div class="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Disconnected</span>
    </div>
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        let term = null, ws = null, currentSessionId = null, fitAddon = null, currentTab = 'active', currentMode = null;
        
        function initTerminal() {
            if (term) term.dispose();
            term = new Terminal({ cursorBlink: currentMode !== 'spectator', fontSize: 14, fontFamily: 'Menlo, Monaco, "Courier New", monospace', theme: { background: '#000000', foreground: '#ffffff' }, scrollback: 10000, disableStdin: currentMode === 'spectator' });
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            const terminalEl = document.getElementById('terminal');
            terminalEl.innerHTML = '';
            term.open(terminalEl);
            fitAddon.fit();
            if (currentMode !== 'spectator') {
                term.onData(data => { if (ws && ws.readyState === WebSocket.OPEN) ws.send(new TextEncoder().encode(data)); });
            }
            const resizeHandler = () => { if (fitAddon) { fitAddon.fit(); if (currentMode !== 'spectator') sendResize(); } };
            window.addEventListener('resize', resizeHandler);
            new ResizeObserver(resizeHandler).observe(terminalEl);
        }
        function sendResize() { if (ws && ws.readyState === WebSocket.OPEN && term) ws.send(JSON.stringify({ type: 'resize', rows: term.rows, cols: term.cols })); }
        function showView(view) {
            document.getElementById('placeholder').style.display = view === 'placeholder' ? 'flex' : 'none';
            document.getElementById('terminal').style.display = view === 'terminal' ? 'block' : 'none';
            document.getElementById('conversationView').style.display = view === 'conversation' ? 'block' : 'none';
            document.getElementById('spectatorBanner').classList.toggle('visible', currentMode === 'spectator');
        }
        function connect(sessionId, mode = 'interactive') {
            if (ws) ws.close();
            currentSessionId = sessionId; currentMode = mode;
            setStatus('connecting'); updateModeBadge(mode);
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${sessionId}?mode=${mode}`);
            ws.binaryType = 'arraybuffer';
            ws.onopen = () => { setStatus(mode === 'spectator' ? 'spectator' : 'connected'); showView('terminal'); initTerminal(); if (mode !== 'spectator') { term.focus(); setTimeout(sendResize, 100); } };
            ws.onmessage = (e) => { if (term) term.write(new Uint8Array(e.data)); };
            ws.onclose = () => { setStatus('disconnected'); currentMode = null; };
            ws.onerror = () => { setStatus('disconnected'); };
        }
        async function browseSession(sessionId, name) {
            if (ws) ws.close();
            currentSessionId = sessionId; currentMode = 'browsing';
            setStatus('browsing'); updateModeBadge('browsing');
            document.getElementById('currentSession').textContent = name;
            try {
                const res = await fetch(`/api/sessions/${sessionId}/history?limit=100`);
                if (!res.ok) throw new Error('Failed');
                renderConversation(await res.json());
                showView('conversation'); closePanel();
            } catch (err) { alert('Failed to load history'); }
        }
        function renderConversation(data) {
            const view = document.getElementById('conversationView');
            let html = `<div class="conv-header"><h2>Session History</h2><div class="meta">${data.message_count} messages</div></div>`;
            for (const msg of data.messages) {
                html += `<div class="message ${msg.role}"><div class="role">${msg.role}</div><div class="content">${escapeHtml(msg.content)}</div></div>`;
            }
            view.innerHTML = html;
            view.scrollTop = view.scrollHeight;
        }
        function updateModeBadge(mode) {
            const badge = document.getElementById('modeBadge');
            badge.textContent = { spectator: 'Viewing', interactive: 'Interactive', browsing: 'Browsing' }[mode] || mode;
            badge.className = 'mode-badge ' + mode;
            badge.style.display = 'inline';
        }
        function setStatus(status) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = { connected: 'Connected', spectator: 'Viewing (Read-Only)', browsing: 'Browsing History', connecting: 'Connecting', disconnected: 'Disconnected' }[status] || status;
        }
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach((t, i) => t.classList.toggle('active', (tab === 'active' && i === 0) || (tab === 'history' && i === 1)));
            document.getElementById('activeSessionList').style.display = tab === 'active' ? 'block' : 'none';
            document.getElementById('historySessionList').style.display = tab === 'history' ? 'block' : 'none';
            if (tab === 'active') refreshActiveSessions();
            if (tab === 'history') refreshHistorySessions();
        }
        async function refreshActiveSessions() {
            try {
                const [tmuxRes, existingRes] = await Promise.all([fetch('/api/sessions'), fetch('/api/existing-sessions?limit=50')]);
                const tmuxData = await tmuxRes.json();
                const existingData = await existingRes.json();
                const runningSessions = existingData.sessions.filter(s => s.is_running && !s.is_in_tmux);
                renderActiveSessions(tmuxData.sessions, runningSessions);
            } catch (err) { console.error(err); }
        }
        async function refreshHistorySessions() {
            try {
                const res = await fetch('/api/existing-sessions?limit=30');
                const data = await res.json();
                renderHistorySessions(data.sessions.filter(s => !s.is_running));
            } catch (err) { console.error(err); }
        }
        function renderActiveSessions(tmuxSessions, runningSessions) {
            const list = document.getElementById('activeSessionList');
            if (!tmuxSessions.length && !runningSessions.length) {
                list.innerHTML = '<div class="no-sessions">No active sessions<br><small>Create one below</small></div>';
                return;
            }
            let html = '';
            for (const s of tmuxSessions) {
                html += `<div class="session-item tmux">
                    <div class="session-name">${escapeHtml(s.working_dir.split('/').pop() || 'Session')} <span class="badge tmux">tmux</span></div>
                    <div class="session-path">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">ID: ${s.id}</div>
                    <div class="session-actions">
                        <button class="session-btn view" onclick="viewSession('${s.id}', '${escapeHtml(s.working_dir)}')">üëÅ View</button>
                        <button class="session-btn attach" onclick="attachSession('${s.id}', '${escapeHtml(s.working_dir)}')">‚å® Attach</button>
                    </div>
                </div>`;
            }
            for (const s of runningSessions) {
                const name = s.working_dir.split('/').pop() || 'Session';
                html += `<div class="session-item terminal">
                    <div class="session-name">${escapeHtml(name)} <span class="badge terminal">terminal</span></div>
                    <div class="session-path">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">${s.session_id.substring(0,8)}...</div>
                    <div class="session-actions">
                        <button class="session-btn browse" onclick="browseSession('${s.session_id}', '${escapeHtml(name)}')">üìñ Browse</button>
                        <button class="session-btn resume" onclick="resumeSession('${s.session_id}', '${escapeHtml(s.working_dir)}')" title="Resume in tmux to enable remote access">üîÑ Take Over</button>
                    </div>
                </div>`;
            }
            list.innerHTML = html;
        }
        function renderHistorySessions(sessions) {
            const list = document.getElementById('historySessionList');
            if (!sessions.length) { list.innerHTML = '<div class="no-sessions">No stopped sessions</div>'; return; }
            list.innerHTML = sessions.map(s => {
                const name = s.working_dir.split('/').pop() || 'Home';
                const timeAgo = getTimeAgo(new Date(s.last_modified));
                return `<div class="session-item">
                    <div class="session-name">${escapeHtml(name)}</div>
                    <div class="session-path">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">${timeAgo} ¬∑ ${s.size_mb} MB</div>
                    <div class="session-actions">
                        <button class="session-btn browse" onclick="browseSession('${s.session_id}', '${escapeHtml(name)}')">üìñ Browse</button>
                        <button class="session-btn resume" onclick="resumeSession('${s.session_id}', '${escapeHtml(s.working_dir)}')">‚ñ∂ Resume</button>
                    </div>
                </div>`;
            }).join('');
        }
        function getTimeAgo(date) { const s = Math.floor((new Date() - date) / 1000); if (s < 60) return 'just now'; if (s < 3600) return Math.floor(s/60) + 'm ago'; if (s < 86400) return Math.floor(s/3600) + 'h ago'; return Math.floor(s/86400) + 'd ago'; }
        function escapeHtml(text) { const d = document.createElement('div'); d.textContent = text; return d.innerHTML; }
        async function createSession() {
            const name = document.getElementById('sessionName').value || 'Claude Session';
            const workingDir = document.getElementById('workingDir').value || '~';
            const resumeId = document.getElementById('resumeId').value || null;
            try {
                let url = `/api/sessions?name=${encodeURIComponent(name)}&working_dir=${encodeURIComponent(workingDir)}&rows=36&cols=120`;
                if (resumeId) url += `&resume_id=${encodeURIComponent(resumeId)}`;
                const res = await fetch(url, { method: 'POST' });
                if (!res.ok) throw new Error('Failed');
                const session = await res.json();
                document.getElementById('resumeId').value = '';
                await refreshActiveSessions();
                attachSession(session.id, session.working_dir);
                switchTab('active'); closePanel();
            } catch (err) { alert('Failed to create session'); }
        }
        function resumeSession(sessionId, workingDir) {
            document.getElementById('sessionName').value = workingDir.split('/').pop() || 'Resumed';
            document.getElementById('workingDir').value = workingDir;
            document.getElementById('resumeId').value = sessionId;
            switchTab('active'); createSession();
        }
        function viewSession(sessionId, name) { document.getElementById('currentSession').textContent = name.split('/').pop(); connect(sessionId, 'spectator'); refreshActiveSessions(); closePanel(); }
        function attachSession(sessionId, name) { document.getElementById('currentSession').textContent = name.split('/').pop(); connect(sessionId, 'interactive'); refreshActiveSessions(); closePanel(); }
        function closePanel() { document.querySelector('.panel').classList.remove('open'); document.querySelector('.overlay').classList.remove('open'); }
        function togglePanel() { document.querySelector('.panel').classList.toggle('open'); document.querySelector('.overlay').classList.toggle('open'); }
        refreshActiveSessions();
        setInterval(refreshActiveSessions, 5000);
    </script>
</body>
</html>
