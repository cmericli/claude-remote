<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Remote</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --accent-green: #4caf50;
            --text-primary: #eee;
            --text-secondary: #aaa;
        }
        
        * { box-sizing: border-box; margin: 0; padding: 0; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: var(--bg-secondary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .logo { font-size: 1.2em; font-weight: 600; color: var(--accent); }
        .session-info { font-size: 0.9em; color: var(--text-secondary); }
        
        main { flex: 1; display: flex; overflow: hidden; }
        
        .panel {
            width: 350px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            display: flex;
            flex-direction: column;
        }
        
        .tabs { display: flex; border-bottom: 1px solid var(--bg-tertiary); }
        
        .tab {
            flex: 1; padding: 10px; text-align: center; cursor: pointer;
            background: none; border: none; color: var(--text-secondary); font-size: 0.9em;
        }
        .tab.active { color: var(--accent); border-bottom: 2px solid var(--accent); }
        
        .session-list { flex: 1; overflow-y: auto; padding: 10px; }
        
        .session-item {
            padding: 12px; margin-bottom: 8px; background: var(--bg-tertiary);
            border-radius: 6px; cursor: pointer; transition: background 0.2s;
            border-left: 3px solid transparent;
        }
        .session-item:hover { background: #1a4a7a; }
        .session-item.active { border-left-color: var(--accent); }
        .session-item.tmux { border-left-color: var(--accent-green); }
        
        .session-name {
            font-weight: 500; margin-bottom: 4px;
            display: flex; align-items: center; gap: 8px;
        }
        .badge {
            font-size: 0.7em; padding: 2px 6px; border-radius: 3px;
            background: var(--accent-green); color: white;
        }
        .session-meta { font-size: 0.8em; color: var(--text-secondary); margin-top: 2px; }
        .session-path {
            font-family: monospace; font-size: 0.75em;
            color: var(--text-secondary); margin-top: 4px; word-break: break-all;
        }
        
        .no-sessions { text-align: center; padding: 40px 20px; color: var(--text-secondary); }
        
        .new-session {
            padding: 15px; border-top: 1px solid var(--bg-tertiary);
        }
        .new-session input {
            width: 100%; padding: 10px; margin-bottom: 8px;
            background: var(--bg-primary); border: 1px solid var(--bg-tertiary);
            border-radius: 4px; color: var(--text-primary); font-size: 0.9em;
        }
        .new-session input:focus { outline: none; border-color: var(--accent); }
        
        .btn {
            width: 100%; padding: 10px; background: var(--accent); color: white;
            border: none; border-radius: 4px; cursor: pointer;
            font-size: 0.9em; font-weight: 500;
        }
        .btn:hover { opacity: 0.9; }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; }
        
        .terminal-container {
            flex: 1; display: flex; flex-direction: column; background: #000;
        }
        .terminal-placeholder {
            flex: 1; display: flex; align-items: center; justify-content: center;
            color: var(--text-secondary); flex-direction: column; gap: 10px;
        }
        #terminal { flex: 1; padding: 10px; }
        
        .status {
            padding: 8px 15px; font-size: 0.85em; background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            display: flex; align-items: center; gap: 8px;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: #666; }
        .status-dot.connected { background: #4caf50; }
        .status-dot.connecting { background: #ff9800; animation: pulse 1s infinite; }
        
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        @media (max-width: 768px) {
            .panel {
                position: fixed; left: 0; top: 0; bottom: 0; z-index: 100;
                transform: translateX(-100%); transition: transform 0.3s;
                width: 85%; max-width: 350px;
            }
            .panel.open { transform: translateX(0); }
            .overlay {
                display: none; position: fixed; inset: 0;
                background: rgba(0,0,0,0.5); z-index: 99;
            }
            .overlay.open { display: block; }
        }
        @media (min-width: 769px) { .menu-toggle, .overlay { display: none; } }
        
        .menu-toggle {
            background: none; border: none; color: var(--text-primary);
            font-size: 1.5em; cursor: pointer; padding: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="menu-toggle" onclick="togglePanel()">☰</button>
            <span class="logo">Claude Remote</span>
        </div>
        <span class="session-info" id="currentSession">No session</span>
    </header>
    
    <main>
        <div class="overlay" onclick="togglePanel()"></div>
        
        <aside class="panel">
            <div class="tabs">
                <button class="tab active" onclick="switchTab('active')">Active</button>
                <button class="tab" onclick="switchTab('history')">History</button>
            </div>
            
            <div class="session-list" id="activeSessionList">
                <div class="no-sessions">No active sessions<br><small>Create one below</small></div>
            </div>
            
            <div class="session-list" id="historySessionList" style="display:none;">
                <div class="no-sessions">Loading...</div>
            </div>
            
            <div class="new-session">
                <input type="text" id="sessionName" placeholder="Session name" value="Claude Session">
                <input type="text" id="workingDir" placeholder="Working directory" value="~">
                <input type="text" id="resumeId" placeholder="Resume session ID (optional)">
                <button class="btn" onclick="createSession()">New Session</button>
            </div>
        </aside>
        
        <div class="terminal-container">
            <div class="terminal-placeholder" id="placeholder">
                <div>Select or create a session</div>
                <small>Sessions persist in tmux - attach from anywhere!</small>
            </div>
            <div id="terminal" style="display:none;"></div>
        </div>
    </main>
    
    <div class="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Disconnected</span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        let term = null, ws = null, currentSessionId = null, fitAddon = null, currentTab = 'active';
        
        function initTerminal() {
            if (term) term.dispose();
            
            term = new Terminal({
                cursorBlink: true, fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: { background: '#000000', foreground: '#ffffff' },
                scrollback: 10000,
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            
            const terminalEl = document.getElementById('terminal');
            terminalEl.innerHTML = '';
            term.open(terminalEl);
            fitAddon.fit();
            
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(new TextEncoder().encode(data));
                }
            });
            
            const resizeHandler = () => { if (fitAddon) { fitAddon.fit(); sendResize(); } };
            window.addEventListener('resize', resizeHandler);
            new ResizeObserver(resizeHandler).observe(terminalEl);
        }
        
        function sendResize() {
            if (ws && ws.readyState === WebSocket.OPEN && term) {
                ws.send(JSON.stringify({ type: 'resize', rows: term.rows, cols: term.cols }));
            }
        }
        
        function connect(sessionId) {
            if (ws) ws.close();
            
            currentSessionId = sessionId;
            setStatus('connecting');
            
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${sessionId}`);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                setStatus('connected');
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('terminal').style.display = 'block';
                initTerminal();
                term.focus();
                setTimeout(sendResize, 100);
            };
            
            ws.onmessage = (e) => { if (term) term.write(new Uint8Array(e.data)); };
            ws.onclose = () => setStatus('disconnected');
            ws.onerror = (err) => { console.error('WebSocket error:', err); setStatus('disconnected'); };
        }
        
        function setStatus(status) {
            document.getElementById('statusDot').className = 'status-dot ' + status;
            document.getElementById('statusText').textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        function switchTab(tab) {
            currentTab = tab;
            document.querySelectorAll('.tab').forEach((t, i) => {
                t.classList.toggle('active', (tab === 'active' && i === 0) || (tab === 'history' && i === 1));
            });
            document.getElementById('activeSessionList').style.display = tab === 'active' ? 'block' : 'none';
            document.getElementById('historySessionList').style.display = tab === 'history' ? 'block' : 'none';
            if (tab === 'history') refreshHistorySessions();
        }
        
        async function refreshSessions() {
            try {
                const res = await fetch('/api/sessions');
                const data = await res.json();
                renderActiveSessions(data.sessions);
            } catch (err) { console.error('Failed to fetch sessions:', err); }
        }
        
        async function refreshHistorySessions() {
            try {
                const res = await fetch('/api/existing-sessions?limit=30');
                const data = await res.json();
                renderHistorySessions(data.sessions);
            } catch (err) { console.error('Failed to fetch history:', err); }
        }
        
        function renderActiveSessions(sessions) {
            const list = document.getElementById('activeSessionList');
            if (!sessions.length) {
                list.innerHTML = '<div class="no-sessions">No active sessions<br><small>Create one below</small></div>';
                return;
            }
            list.innerHTML = sessions.map(s => `
                <div class="session-item tmux ${s.id === currentSessionId ? 'active' : ''}" 
                     onclick="attachSession('${s.id}', '${escapeHtml(s.working_dir)}')">
                    <div class="session-name">
                        ${escapeHtml(s.working_dir.split('/').pop() || 'Session')}
                        <span class="badge">tmux</span>
                    </div>
                    <div class="session-path">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">ID: ${s.id}</div>
                </div>
            `).join('');
        }
        
        function renderHistorySessions(sessions) {
            const list = document.getElementById('historySessionList');
            if (!sessions.length) {
                list.innerHTML = '<div class="no-sessions">No session history</div>';
                return;
            }
            list.innerHTML = sessions.map(s => {
                const date = new Date(s.last_modified);
                const timeAgo = getTimeAgo(date);
                return `
                <div class="session-item" onclick="resumeSession('${s.session_id}', '${escapeHtml(s.working_dir)}')">
                    <div class="session-name">${escapeHtml(s.working_dir.split('/').pop() || 'Home')}</div>
                    <div class="session-path">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">${timeAgo} · ${s.size_mb} MB</div>
                    <div class="session-meta" style="font-family:monospace;font-size:0.7em;">${s.session_id.substring(0, 8)}...</div>
                </div>
            `}).join('');
        }
        
        function getTimeAgo(date) {
            const s = Math.floor((new Date() - date) / 1000);
            if (s < 60) return 'just now';
            if (s < 3600) return Math.floor(s / 60) + 'm ago';
            if (s < 86400) return Math.floor(s / 3600) + 'h ago';
            return Math.floor(s / 86400) + 'd ago';
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function createSession() {
            const name = document.getElementById('sessionName').value || 'Claude Session';
            const workingDir = document.getElementById('workingDir').value || '~';
            const resumeId = document.getElementById('resumeId').value || null;
            
            try {
                let url = `/api/sessions?name=${encodeURIComponent(name)}&working_dir=${encodeURIComponent(workingDir)}&rows=36&cols=120`;
                if (resumeId) url += `&resume_id=${encodeURIComponent(resumeId)}`;
                
                const res = await fetch(url, { method: 'POST' });
                if (!res.ok) throw new Error('Failed to create session');
                const session = await res.json();
                
                document.getElementById('resumeId').value = '';
                await refreshSessions();
                attachSession(session.id, session.working_dir);
                switchTab('active');
                closePanel();
            } catch (err) {
                console.error('Failed to create session:', err);
                alert('Failed to create session: ' + err.message);
            }
        }
        
        function resumeSession(sessionId, workingDir) {
            document.getElementById('sessionName').value = workingDir.split('/').pop() || 'Resumed Session';
            document.getElementById('workingDir').value = workingDir;
            document.getElementById('resumeId').value = sessionId;
            switchTab('active');
            createSession();
        }
        
        function attachSession(sessionId, workingDir) {
            document.getElementById('currentSession').textContent = workingDir.split('/').pop() || sessionId;
            connect(sessionId);
            refreshSessions();
            closePanel();
        }
        
        function closePanel() {
            document.querySelector('.panel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('open');
        }
        
        function togglePanel() {
            document.querySelector('.panel').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('open');
        }
        
        refreshSessions();
        setInterval(refreshSessions, 5000);
    </script>
</body>
</html>
