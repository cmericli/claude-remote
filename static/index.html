<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Claude Remote</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/xterm@5.3.0/css/xterm.css">
    <style>
        :root {
            --bg-primary: #1a1a2e;
            --bg-secondary: #16213e;
            --bg-tertiary: #0f3460;
            --accent: #e94560;
            --text-primary: #eee;
            --text-secondary: #aaa;
        }
        
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            height: 100vh;
            display: flex;
            flex-direction: column;
        }
        
        header {
            background: var(--bg-secondary);
            padding: 12px 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid var(--bg-tertiary);
        }
        
        .logo {
            font-size: 1.2em;
            font-weight: 600;
            color: var(--accent);
        }
        
        .session-info {
            font-size: 0.9em;
            color: var(--text-secondary);
        }
        
        main {
            flex: 1;
            display: flex;
            overflow: hidden;
        }
        
        /* Session List Panel */
        .panel {
            width: 300px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--bg-tertiary);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .panel-header {
            padding: 15px;
            border-bottom: 1px solid var(--bg-tertiary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .panel-title {
            font-weight: 600;
        }
        
        .session-list {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
        }
        
        .session-item {
            padding: 12px;
            margin-bottom: 8px;
            background: var(--bg-tertiary);
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .session-item:hover {
            background: #1a4a7a;
        }
        
        .session-item.active {
            border-left: 3px solid var(--accent);
        }
        
        .session-name {
            font-weight: 500;
            margin-bottom: 4px;
        }
        
        .session-meta {
            font-size: 0.8em;
            color: var(--text-secondary);
        }
        
        .no-sessions {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }
        
        /* New Session Form */
        .new-session {
            padding: 15px;
            border-top: 1px solid var(--bg-tertiary);
        }
        
        .new-session input {
            width: 100%;
            padding: 10px;
            margin-bottom: 8px;
            background: var(--bg-primary);
            border: 1px solid var(--bg-tertiary);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.9em;
        }
        
        .new-session input:focus {
            outline: none;
            border-color: var(--accent);
        }
        
        .btn {
            width: 100%;
            padding: 10px;
            background: var(--accent);
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 500;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Terminal */
        .terminal-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: #000;
        }
        
        .terminal-placeholder {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
        }
        
        #terminal {
            flex: 1;
            padding: 10px;
        }
        
        /* Connection status */
        .status {
            padding: 8px 15px;
            font-size: 0.85em;
            background: var(--bg-secondary);
            border-top: 1px solid var(--bg-tertiary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
        }
        
        .status-dot.connected {
            background: #4caf50;
        }
        
        .status-dot.connecting {
            background: #ff9800;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        /* Mobile */
        @media (max-width: 768px) {
            .panel {
                position: fixed;
                left: 0;
                top: 0;
                bottom: 0;
                z-index: 100;
                transform: translateX(-100%);
                transition: transform 0.3s;
            }
            
            .panel.open {
                transform: translateX(0);
            }
            
            .menu-toggle {
                display: block;
            }
            
            .overlay {
                display: none;
                position: fixed;
                inset: 0;
                background: rgba(0,0,0,0.5);
                z-index: 99;
            }
            
            .overlay.open {
                display: block;
            }
        }
        
        @media (min-width: 769px) {
            .menu-toggle, .overlay {
                display: none;
            }
        }
        
        .menu-toggle {
            background: none;
            border: none;
            color: var(--text-primary);
            font-size: 1.5em;
            cursor: pointer;
            padding: 5px;
        }
    </style>
</head>
<body>
    <header>
        <div style="display: flex; align-items: center; gap: 15px;">
            <button class="menu-toggle" onclick="togglePanel()">☰</button>
            <span class="logo">Claude Remote</span>
        </div>
        <span class="session-info" id="currentSession">No session</span>
    </header>
    
    <main>
        <div class="overlay" onclick="togglePanel()"></div>
        
        <aside class="panel">
            <div class="panel-header">
                <span class="panel-title">Sessions</span>
                <button onclick="refreshSessions()" style="background:none;border:none;color:var(--text-secondary);cursor:pointer;">↻</button>
            </div>
            
            <div class="session-list" id="sessionList">
                <div class="no-sessions">No active sessions</div>
            </div>
            
            <div class="new-session">
                <input type="text" id="sessionName" placeholder="Session name" value="Claude Session">
                <input type="text" id="workingDir" placeholder="Working directory" value="~">
                <button class="btn" onclick="createSession()">New Session</button>
            </div>
        </aside>
        
        <div class="terminal-container">
            <div class="terminal-placeholder" id="placeholder">
                Select or create a session to begin
            </div>
            <div id="terminal" style="display:none;"></div>
        </div>
    </main>
    
    <div class="status">
        <span class="status-dot" id="statusDot"></span>
        <span id="statusText">Disconnected</span>
    </div>
    
    <script src="https://cdn.jsdelivr.net/npm/xterm@5.3.0/lib/xterm.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-fit@0.8.0/lib/xterm-addon-fit.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/xterm-addon-web-links@0.9.0/lib/xterm-addon-web-links.min.js"></script>
    <script>
        let term = null;
        let ws = null;
        let currentSessionId = null;
        let fitAddon = null;
        
        // Initialize terminal
        function initTerminal() {
            if (term) {
                term.dispose();
            }
            
            term = new Terminal({
                cursorBlink: true,
                fontSize: 14,
                fontFamily: 'Menlo, Monaco, "Courier New", monospace',
                theme: {
                    background: '#000000',
                    foreground: '#ffffff',
                },
                scrollback: 10000,
            });
            
            fitAddon = new FitAddon.FitAddon();
            term.loadAddon(fitAddon);
            term.loadAddon(new WebLinksAddon.WebLinksAddon());
            
            const terminalEl = document.getElementById('terminal');
            terminalEl.innerHTML = '';
            term.open(terminalEl);
            fitAddon.fit();
            
            // Handle terminal input
            term.onData(data => {
                if (ws && ws.readyState === WebSocket.OPEN) {
                    ws.send(new TextEncoder().encode(data));
                }
            });
            
            // Handle resize
            window.addEventListener('resize', () => {
                if (fitAddon) {
                    fitAddon.fit();
                    sendResize();
                }
            });
            
            new ResizeObserver(() => {
                if (fitAddon) {
                    fitAddon.fit();
                    sendResize();
                }
            }).observe(terminalEl);
        }
        
        function sendResize() {
            if (ws && ws.readyState === WebSocket.OPEN && term) {
                ws.send(JSON.stringify({
                    type: 'resize',
                    rows: term.rows,
                    cols: term.cols,
                }));
            }
        }
        
        // WebSocket connection
        function connect(sessionId) {
            if (ws) {
                ws.close();
            }
            
            currentSessionId = sessionId;
            setStatus('connecting');
            
            const protocol = location.protocol === 'https:' ? 'wss:' : 'ws:';
            ws = new WebSocket(`${protocol}//${location.host}/api/terminal/${sessionId}`);
            ws.binaryType = 'arraybuffer';
            
            ws.onopen = () => {
                setStatus('connected');
                document.getElementById('placeholder').style.display = 'none';
                document.getElementById('terminal').style.display = 'block';
                initTerminal();
                term.focus();
                sendResize();
            };
            
            ws.onmessage = (event) => {
                if (term) {
                    term.write(new Uint8Array(event.data));
                }
            };
            
            ws.onclose = () => {
                setStatus('disconnected');
            };
            
            ws.onerror = (err) => {
                console.error('WebSocket error:', err);
                setStatus('disconnected');
            };
        }
        
        function setStatus(status) {
            const dot = document.getElementById('statusDot');
            const text = document.getElementById('statusText');
            
            dot.className = 'status-dot ' + status;
            text.textContent = status.charAt(0).toUpperCase() + status.slice(1);
        }
        
        // Session management
        async function refreshSessions() {
            try {
                const res = await fetch('/api/sessions');
                const data = await res.json();
                renderSessions(data.sessions);
            } catch (err) {
                console.error('Failed to fetch sessions:', err);
            }
        }
        
        function renderSessions(sessions) {
            const list = document.getElementById('sessionList');
            
            if (sessions.length === 0) {
                list.innerHTML = '<div class="no-sessions">No active sessions</div>';
                return;
            }
            
            list.innerHTML = sessions.map(s => `
                <div class="session-item ${s.id === currentSessionId ? 'active' : ''}" 
                     onclick="attachSession('${s.id}', '${s.name}')">
                    <div class="session-name">${escapeHtml(s.name)}</div>
                    <div class="session-meta">${escapeHtml(s.working_dir)}</div>
                    <div class="session-meta">ID: ${s.id}</div>
                </div>
            `).join('');
        }
        
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }
        
        async function createSession() {
            const name = document.getElementById('sessionName').value || 'Claude Session';
            const workingDir = document.getElementById('workingDir').value || '~';
            
            try {
                const res = await fetch(`/api/sessions?name=${encodeURIComponent(name)}&working_dir=${encodeURIComponent(workingDir)}&rows=24&cols=80`, {
                    method: 'POST',
                });
                const session = await res.json();
                
                await refreshSessions();
                attachSession(session.id, session.name);
                
                // Close panel on mobile
                document.querySelector('.panel').classList.remove('open');
                document.querySelector('.overlay').classList.remove('open');
            } catch (err) {
                console.error('Failed to create session:', err);
                alert('Failed to create session');
            }
        }
        
        function attachSession(sessionId, name) {
            document.getElementById('currentSession').textContent = name;
            connect(sessionId);
            refreshSessions();
            
            // Close panel on mobile
            document.querySelector('.panel').classList.remove('open');
            document.querySelector('.overlay').classList.remove('open');
        }
        
        function togglePanel() {
            document.querySelector('.panel').classList.toggle('open');
            document.querySelector('.overlay').classList.toggle('open');
        }
        
        // Initial load
        refreshSessions();
        setInterval(refreshSessions, 10000);  // Refresh every 10s
    </script>
</body>
</html>
